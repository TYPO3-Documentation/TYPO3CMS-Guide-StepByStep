#!/usr/bin/env php
<?php
define('SEARCH_PATH', realpath(__DIR__ . '/../Documentation'));

$filesAndLinks = json_decode(file_get_contents(SEARCH_PATH . '/files.json'), true);

foreach ($filesAndLinks['files'] as $file) {
    // Ignore index files
    if (basename($file['path']) === 'Index.md') {
        continue;
    }

    $matchedFile = null;

    $fileContents = file_get_contents(SEARCH_PATH . $file['path']);

    $changedLinks = 0;

    foreach ($filesAndLinks['links'] as $link) {
        // Only care about internal links within this file
        if ($link['inFile'] !== $file['path'] || $link['external']) {
            continue;
        }

        $changedLinks++;

        $replaceLinkString = $link['linkText'];

        // If the file exists, ensure we make a proper link to it
        if ($link['toFile'] !== null) {
            $replaceLinkString = '[' . $link['linkText'] . ']'
                . '(' . $link['toFile'] . ')'
                . ($link['titleAttribute'] ? ' "' . $link['titleAttribute'] . '"' : '')
                . ')';
        }

        $fileContents = str_replace(
            $link['match'],
            $replaceLinkString,
            $fileContents
        );
    }

    if ($changedLinks > 0) {
        file_put_contents(SEARCH_PATH . $file['path'], $fileContents);
    }
}